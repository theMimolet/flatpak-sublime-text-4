app-id: com.sublimehq.SublimeText
command: subl

runtime: org.freedesktop.Sdk
runtime-version: '25.08'
sdk: org.freedesktop.Sdk

separate-locales: false
finish-args:
- --share=ipc
- --share=network
- --device=dri
- --socket=x11
- --talk-name=org.gnome.SettingsDaemon
- --filesystem=host
- --env=PATH=/app/utils/bin:/app/sublime_merge/bin:/app/bin:/usr/bin
- --env=PYTHONPATH=/app/utils/lib/python3.8/site-packages

add-extensions:
  com.sublimemerge.App:
    directory: sublime_merge
    add-ld-path: lib

modules:
- name: sublime
  buildsystem: simple
  sources:
  - type: script
    dest-filename: apply_extra
    commands:
    - FLATPAK_ID=com.sublimehq.SublimeText
    # Extract upstream package
    - mkdir -p extract export/share
    - tar -xJf sublime.tar.xz -C extract
    # Install icons only (we'll use our custom desktop file)
    - mv extract/sublime_text/Icon export/share/
    - rename sublime-text ${FLATPAK_ID} export/share/icons/hicolor/*/apps/*
    # Install the app
    - mv extract/sublime_text ./
    - ln -sr /app/sublime_merge/extra/sublime_merge ./sublime_merge
    # Cleanup
    - rm -rf extract sublime.tar.xz
  - type: script
    dest-filename: subl
    commands:
    - exec /app/extra/sublime_text/sublime_text --fwdargv0 "$0" "$@"
  - type: extra-data
    only-arches: [ x86_64 ]
    filename: sublime.tar.xz
    url: https://download.sublimetext.com/sublime_text_build_4200_x64.tar.xz
    sha256: 36f69c551ad18ee46002be4d9c523fe545d93b67fea67beea731e724044b469f
    size: 16340980
    x-checker-data:
      type: html
      url: https://www.sublimetext.com/download_thanks
      version-pattern: https://download.sublimetext.com/sublime_text_build_([\d\.-]*)_x64.tar.xz
      url-template: https://download.sublimetext.com/sublime_text_build_${version}_x64.tar.xz
  - type: extra-data
    only-arches: [ aarch64 ]
    filename: sublime.tar.xz
    url: https://download.sublimetext.com/sublime_text_build_4200_arm64.tar.xz
    sha256: cf4b6aa74ea2a2aab02e144599cf9e4a423cbb9543c221f7da1095a95495566a
    size: 15743920
    x-checker-data:
      type: html
      url: https://www.sublimetext.com/download_thanks
      version-pattern: https://download.sublimetext.com/sublime_text_build_([\d\.-]*)_arm64.tar.xz
      url-template: https://download.sublimetext.com/sublime_text_build_${version}_arm64.tar.xz
  - type: file
    path: com.sublimehq.SublimeText.desktop
  - type: file
    path: com.sublimehq.SublimeText.appdata.xml
  - type: file
    path: com.sublimehq.SublimeText-256.png
  build-commands:
  - mkdir -p /app/lib
  - install -Dm755 apply_extra -t /app/bin
  - install -Dm755 subl /app/bin/subl
  - install -Dm644 com.sublimehq.SublimeText.desktop /app/share/applications/com.sublimehq.SublimeText.desktop
  - install -Dm644 com.sublimehq.SublimeText.appdata.xml /app/share/appdata/com.sublimehq.SublimeText.appdata.xml
  - install -Dm644 com.sublimehq.SublimeText-256.png /app/share/icons/hicolor/256x256/apps/com.sublimehq.SublimeText.png
  # This creates the mount point for the extensions.
  - mkdir -p /app/utils
  - mkdir -p /app/sublime_merge
